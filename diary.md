# AHC030日記

## 1日目（2/9）

弊社懇親会で食べ過ぎて胃がめちゃくちゃ痛い。無理。寝る（痛みでなかなか眠れません……）。

## 2日目（2/10）

胃、復活……。

問題は昨日胃が痛くないうちに読んでた。面白そうなんだが、取っかかりが掴めない。尤度計算してごにょごにょしてみたいなことがやりたいが、油田の位置が独立でないので困難に見える。

一応気付きメモ。

- 標準偏差は k ではなく √k に比例
- 各ポリオミノは連結なのでそれを使って枝刈りできる？
- 平均は k/2 に向けて中央に寄る
- 対数尤度最大化のビムサ・焼きなまし
  - 大きいポリオミノから順に選ぶと枝刈りしやすい？
  - 2つ消して最適な場所に入れ直す近傍
- 使うマスを1個決め打てばポリオミノの置き方はポリオミノサイズを T として O(N^2) から O(T) に落ちる
- Zobrist Hashで置き場所の一致判定

とりあえずサンプルコードと同じ愚直をする。まあこれはOK。9,720Mで137位。意外とまだ提出者数少ないな。

相対スコア形式なので、TopCoder MMのツールみたいに手元で相対スコアを比較できるツールをRustで作ってみる。logスコアでも良いんだけど、パッと見で感覚が掴みづらいためこっちの方が個人的に考察しやすそう。なんで今まで作ってなかったんだというのはさておき……。

占いをどう使えば良いのか全く分からないので、まずは脳筋掘り掘り解法を考える。適当に掘って、掘った結果と矛盾しない油田の位置を山登りで決める。矛盾の数が0かつ、そのような油田の位置が1通りしかなければそれを答えとする。山登りは雑すぎると全然筋の良い近傍に当たらないと思われるため、部分破壊して貪欲に再構築。上手く行くかはやってみないと分からん。

作って投げた。1WA。そういえばWAが付いても順位表の点数は更新されるのか。21位で19,400Mくらい（うろ覚え）。矛盾しない油田の位置を一生見付けられなかったときにWAが出ていたので、全マス掘ったらそれを出力することにする。

ついでに次の調査点の選び方を少し工夫する。掘り方の候補が一意でないとき、適当に2つの掘り方を持ってきてその2つが区別可能となるような場所を掘る。33,391Mで5位。よしよし。

油田の数が少ないケースは異常なほど少ない手数で特定できててびっくりする。5手とかで行けるのはさすがに想像していなかった。凄いな。

調査点の選び方をもう少し工夫。掘り方の候補を50個くらい持ってきて、調査することで候補を半分に絞れるような場所を選ぶ。理想的にはlog回くらいで抑えられるようになるはず。38,187Mで3位。スタートダッシュは成功。

あとはリファクタとか。……と思ったが、次の調査点を選ぶときにエントロピーを考えると良さそうなことに気付いた。入れると微妙にだが改善されてそう。29,633Mで3位。

順位・得点の推移はこんな感じ。周りも提出が増えて相対スコアがどんどん落ちていく。すぐ答えられるケースはどうしても運ゲーになるから気にしてもしょうがなさそう（だが、1手縮むと大きいので後々詰める必要はある……）。

- 137th 9,720M
- 21st 19,400Mくらい
- 5th 33,391M
- 3rd 38,187M
- 3rd 29,338M
- 3rd 29,633M

山登りの性能にまだ不満がある（結構誤答したり貪欲のせいで局所解にハマったりする）けど、まだ序盤だしこれ以上詰めてもしょうがないか。占いの嬉しさがまだ分かってないのでちゃんと考察しないと……。

アイデアを思い付いてしまった。初手もクエリを投げる前に山登りしてエントロピー最大の点を選んだ方が良いな。投げると絶対スコアは悪化したが相対スコアは改善。すぐ見つかるケースに効くはずなので直感的にも合ってそう。29,481Mで2位。ちまちま改善するのやめられないな。

## 3日目（2/11）

占いのコストを1/√kじゃなくて√kだと勘違いしてた。あっっっっぶな。√kじゃあんまりありがたみないなーと思ってたけど納得。

山登りの近傍、貪欲に構築していくんじゃなくて「1個置いたときの嬉しさ」が上位となる置き場所に絞った上で組合せを全探索するとよいのではと思って実装してみた。結果はダメ。ビジュアライザを見ると原因がよく分かって、全ての油田を同じ場所に置こうとしてしまうケースがある。なるほどなあ。ボツ。

運転免許証の更新に行く。ずっとPCの前にかじりついていたから良い気分転換になる。

移動ついでに考察を進める。占いの嬉しさについて。簡単のために占いの分散が0だったとすると、以下の手順でv1, v2, v3の値を安く特定できる。

1. v1 + v2 の値をコスト 1/√2 で占う
2. v1 + v3 の値をコスト 1/√2 で占う
3. v2 + v3 の値をコスト 1/√2 で占う
4. 連立方程式を立て、v1, v2, v3について解く

1.～3.は一次独立でさえあれば良いが、分散を考えなければたくさん選んだ方が得なのでこのようにしている。これで3箇所のvの値をコスト3/√2で特定できた。k箇所について同じことをやると通常の1/√(k-1)倍のコストで特定できる。これはかなり嬉しい。一方で問題点もあって、

- 結果がばらつく
- 次に調査する点集合の選び方が難しくなる

などが出てきそう。後者は得られる情報量のコスパが最大になるような点集合を焼きなましで求める？ちょっとまだよく分からないな。あとこの問題はAHC003にちょっと似てる気もしてきた。サンプリングは容易なので、あるマスとその隣のマスなどの共分散なども求められそうな気がする。

取得した情報と矛盾しない回を見付ける山登り、MCMCと解釈するのが自然かもしれない。違反量が0から0に遷移するときはその確率が等しいから常に遷移が可能で、0から1に遷移するときは確率が正の値から0になるから常に棄却されると考えるとMCMCの枠組みに沿っている気がする。既約性とか詳細釣り合い条件とかはたぶん満たされてないけど。

Jirotechさんが今までの1.5倍くらいのスコアを取ってる。まあそのくらいは行くよねえ。

MCMCの実装を頑張る。と言っても焼きなましとほとんど変わらない。変わったのは観測結果と配置に応じて尤度を計算する部分。あと貪欲部分も尤度の比に応じて選択するように修正した。点の選び方は超適当で、選ぶ個数Cを[N^2/4, N^2/2]の中からランダムに決めた上で一様ランダムにC個のマスを選択してるだけ。この辺は改善余地がありそう。

バグらせつつも実装完了。頑張った甲斐あってseed=0ではそれっぽく動いてそうに見える。ただepsが大きかったり油田の数が多かったりすると悪化してそうなので、適当に閾値を決めて今までのソルバーとどちらにするか選択するようにした。手元スコアで30%増くらいになってそうに見える。

投げた。7th 23,921M -> 3rd 29,150M。手元通りとまでは行かないけどいい感じ。諸々適当にしてしまっているので、続きはまた明日。

## 4日目（2/12）

MCMCの近傍を改善した。今までは適当なk個の油田を削除し、油田を1つずつ配置する（配置確率は尤度の比で乱択）貪欲だったが、削除するととりあえず足りないところに置いていこうとしてしまうため、削除せずランダムなところに移動することにした。

手元だと1割くらい伸びてるので投げる。34,271M点で1位になってしまった。2位は29,964M点。2割くらい伸びているが誰がそこまでやれと。上振れ&テストケースの相性が良かっただけな気がするので油断しないようにしないと。とはいえ1位は嬉しい。

調査の分散は個々のマスの分散の和になってる？やっぱりAHC003っぽく解釈できるかも。要検討。

MCMCの遷移をする際、全探索中に対数尤度を計算するのがあまりにも重すぎるのでSuccessive Halvingっぽく枝刈りをするとよいのでは？

Successive Halving、やってみたけどダメだった。オーバーヘッドのせいでむしろちょっと遅くなる。うーん……。

AHC003のやつ、理解を深めることも兼ねてやってみる。事前分布はランダムサンプリングで得られて、事後分布の更新式は[eivourさんの記事](https://qiita.com/contramundum/items/b945400b81536df42d1a)を参考に、というかそのまま実装してみる。

seed=0では推定に成功したけど、さすがにそれ以上になると無理っぽいな。さすがにこれを正規分布として考えるのは無理があったか。しかし事後分布が徐々に更新されていくさまは結構面白いな。

MCMCで得られた解の候補、今まで毎回捨てて一番良いやつだけ残してたけど、どう考えても見つかったやつは全部取っておいた方が良いな。見つかったものリストに入れておいて、尤度が相対的に小さくなったやつは捨てていく。これを実装すると 2nd 30,794M -> 1st 32,988M (2位スコアは31,274M -> 29,357M)。思ったより上がった。よしよし。

**メモ:** 配置が違ってもv>0のマスの集合が同じになるケースがあるかも。優先度は低いけど忘れずにケアしないと。

eijirouさんが初提出してきた。eijirouさんが44,842Mで自分が26,224M。一気に上げてきて凄い。1.7倍かあ……。まあ行けなくもないか……？改善案絞りきってこれだったら絶望感あるけど、まだまだ試したいことがあるので比較的気持ちは楽。

今はランダムなマスの集合をクエリとして投げていて、これは明らかに無駄が大きそう。現状でも候補をいくつかに絞ってからなかなか対数尤度の差が広がらっていない。ランダムにやるとvが正のマスと0のマスが打ち消し合って区別が付かないので、これをもっと賢くしないとダメ。クエリによって得られる情報量のコスパを最大にしたくて、そうするとやっぱり焼きなますのが良い気がする。情報量周りで色々絡まっててちょっと難しいので、情報理論の入門書を読みながら明日考えることにする。今日は寝よう。

**メモ:** 1番手と2番手の尤度が100倍になったら答えるようにしてるけど、もっと差を小さくして良い気がする。お手つきしてもコスト1なので、10倍くらいで良いか？

## 5日目（2/13）

相互情報量完全に理解した。というのは嘘で、本読みながら丁寧に式を立てていかないと厳しい。

占いをするマスの集合を適切に選ぶことで、「占いの結果を知ることで得られる情報量をコストで割ったもの」を最大化したい。これは占いをするマスの集合を焼きなませばよい。賢い差分計算は思い付いていないので、とりあえずナイーブに求めることにする。

実装できた。手元スコアだと1.5倍くらいになっていて、期待ほどではないが悪くない。なのだが、投げてみると2割くらいしか改善していない。うーん、テストケースが偏ってたりeijirouさんがいくつかのケースで凄いスコア取ってて全員無に帰してたりするのかなあ。

と思ったらコストを1/√kではなく√kで計算していた。アホすぎる。道理で選ぶマス数が少ないわけだ。修正。

eijirouさんスコア/terry_u16スコアの推移はこんな感じ。50ケースしかないのでブレまくる。

1. 43,323M/25,101M（昨日の提出分）
2. 42,863M/29,137M（今日の初提出）
3. 41,702M/32,164M（コストバグを修正）
4. 42,717M/29,690M（え？）
5. 42,742M/30,308M（諸々改善したつもりが……）

実行時間を10倍にすると2割くらい点が伸びてそう。高速化も考えないといけないな……。

**TODO:** SingleDigSolverもStateを捨てずにプールするようにする。

## 6日目（2/14）

MCMCで少しだけ油田をずらす近傍を追加してみる。ダメだった。ボツ。

2重ループの中でlogを計算すると焼きなまし回るものも回らんのでちゃんとやる。

やった。ついでに諸々高速化。2倍速にはなったはず。でもスコアが改善しているのかどうかイマイチ分からん……。5%くらいは伸びていそうだが。

色々試す。採用したものを挙げる。不採用のものはたぶん倍くらいあるが、メモってないので忘れた……。

- 調査点サンプリングの初期解を工夫
- MCMCの近傍操作結果が元と同じ解にならないように制約をかける
- 高速化
- 高速化
- 調査点サンプリングの近傍にIndexSetを使用
- 調査点サンプリング開始時に尤度の低い配置は使用しないようにした

bowwowforeach さんが一気に1位に来た。ぐえー。と思ったらeijirouさんが抜き返している。ぐえー。神々の戦いに振り回されている。

**メモ:** そもそも絶対にあり得なさそうな置き場所は探索時にスキップできる。

焼きなましよりビームサーチの方が良い？さすがにそんなことはないか……。と思ったが、AHC019的なノリでできないか？いやそれと同じ考えのものが状態プール焼きなましか。

MCMCを状態プール焼きなましに変えてみる。といっても焼きなましかどうかすら怪しくて、結局BFSっぽい何かになった。stateの集合を持っておき、尤度の比に応じてstateをサンプリングし、近傍操作を行った上で未知のstateが得られれば集合に追加する。

結構伸びるかと思ったが微妙。数%くらいしか変わらない。うーん……。

現在3位。2位になるには1.25倍くらい、1位になるには1.4倍くらいのスコアが必要。

実行時間を伸ばしてスコアが伸びるか試してみた。時間を伸ばすと安定感が上がるので、1箇所掘り解法との併用をしなくて良くなる。それ込みでのスコア増加量は、

- 実行時間5倍: 4割増し
- 実行時間10倍: 5割増し

MCMCの実行時間を伸ばしても調査点サンプリングの実行時間を伸ばしてもスコアが上がる。圧倒的に速度か効率性が足りない。MCMCの近傍で油田ごとに置き場所を全探索しているのが重いので、「そもそも絶対にあり得なさそうな置き場所は探索時にスキップできる」を取り入れたいところ。以前ちょっとやったAHC003方式で尤度を求めると、絶対に置かれなさそうな場所の探索はスキップできる？明日試す。
